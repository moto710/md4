<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Template</title>
    <th:block th:fragment="head">
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/assets/bootstrap/v5.3.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="/assets/fontawesome/v5.15.4/css/all.min.css">
        <link rel="stylesheet" href="/assets/sweetalert2/v11.7.0/sweetalert2.min.css">
        <link rel="stylesheet" href="/assets/css/style.css">
    </th:block>
</head>
<body>

<th:block th:fragment="script">
    <script src="/assets/jquery/v3.6.3/jquery-3.6.3.min.js"></script>
    <script src="/assets/bootstrap/v5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/sweetalert2/v11.7.0/sweetalert2.min.js"></script>
    <script src="/assets/js/appBase.js"></script>
    <script>
        let customer = {};

        const page = {
            urls: {
                getAllCustomers: appBase.API_CUSTOMER,
                getCustomerById: appBase.API_CUSTOMER,
                doDeposit: appBase.API_DEPOSIT,
                doWithdraw: appBase.API_WITHDRAW,
                doTransfer: appBase.API_TRANSFER
            }
        }

        function getAllCustomers() {
            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "GET",
                url: page.urls.getAllCustomers
            })
                .done((data) => {
                    $.each(data, (i, item) => {
                        let str = renderCustomer(item);
                        document.querySelector("#tbCustomer tbody").innerHTML += str;
                    })

                    allAddEvent();
                })
                .fail((error) => {
                    console.log(error)
                })
        }

        function addEventShowModalUpdate() {
            $(".update").on("click", function () {
                let customerId = $(this).data("id");

                findById(customerId).then(() => {

                    if (customer !== null) {
                        $("#idUp").val(customer.id);
                        $("#fullNameUp").val(customer.fullName);
                        $("#emailUp").val(customer.email);
                        $("#phoneUp").val(customer.phone);
                        $("#addressUp").val(customer.address);

                        $("#modalUpdate").modal("show");
                    }
                });
            })
        }

        function addEventShowModalDeposit() {
            $(".deposit").on("click", function () {
                let customerId = $(this).data("id");

                findById(customerId).then(() => {
                    if (customer !== null) {
                        $("#idDep").val(customer.id);
                        $("#fullNameDep").val(customer.fullName);
                        $("#balanceDep").val(customer.balance);

                        $("#modalDeposit").modal("show");
                    }
                });
            })
        }

        function addEventShowModalWithdraw() {
            $(".withdraw").on("click", function () {
                let customerId = $(this).data("id");

                findById(customerId).then(() => {
                    if (customer !== null) {
                        $("#idWith").val(customer.id);
                        $("#fullNameWith").val(customer.fullName);
                        $("#balanceWith").val(customer.balance);

                        $("#modalWithdraw").modal("show");
                    }
                });
            })
        }

        function addEventShowModelTransfer() {
            $(".transfer").on("click", function () {
                let senderId = $(this).data("id");

                findById(senderId).then(() => {
                    if (customer !== null) {
                        $("#idSend").val(customer.id);
                        $("#fullNameSend").val(customer.fullName);
                        $("#emailSend").val(customer.email);
                        $("#balanceSend").val(customer.balance);

                        $.ajax({
                            headers: {
                                "accept": "application/json",
                                "content-type": "application/json"
                            },
                            type: "GET",
                            url: page.urls.getAllCustomers
                        })
                            .done((data) => {
                                $.each(data, (i, item) => {
                                    if (item.id !== senderId) {
                                        let str = renderSelectOptionRecipient(item);
                                        document.querySelector("#recipientId").insertAdjacentHTML("beforeend", str);
                                    }
                                })

                                countTransferTransaction();

                                allAddEvent();
                            })
                            .fail((error) => {
                                console.log(error)
                            })

                        $("#modalTransfer").modal("show");
                    }
                });
            })
        }

        function addEventShowConfirmDelete() {
            $(".delete").on("click", function () {
                let customerId = $(this).data("id");

                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {

                        let customer = {
                            deleted: 1
                        }

                        $.ajax({
                            headers: {
                                "accept": "application/json",
                                "content-type": "application/json"
                            },
                            type: "PATCH",
                            url: page.urls.getAllCustomers + "/" + customerId,
                            data: JSON.stringify(customer)
                        })
                            .done((data) => {
                                $("#tr_" + customerId).remove();

                                Swal.fire({
                                    position: 'top-end',
                                    icon: 'success',
                                    title: 'Delete customer successful',
                                    showConfirmButton: false,
                                    timer: 1500
                                })
                            })
                            .fail((error) => {
                                console.log(error)
                            })
                    }
                })
            })
        }

        function renderSelectOptionRecipient(item) {
            return `
                    <option value="${item.id}">${item.fullName}</option>
            `;
        }

        function renderCustomer(item) {
            return `
                <tr id="tr_${item.id}">
                    <td class="text-center">${item.id}</td>
                    <td>${item.fullName}</td>
                    <td class="text-center">${item.email}</td>
                    <td class="text-center">${item.phone}</td>
                    <td class="text-end">${item.balance}</td>
                    <td>${item.address}</td>
                    <td>
                        <button type="button" class="btn btn-outline-secondary update" data-id="${item.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                    <td>
                        <button type="button" class="btn btn-outline-success deposit" data-id="${item.id}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>
                    <td>
                        <button type="button" class="btn btn-outline-warning withdraw" data-id="${item.id}">
                            <i class="fas fa-minus"></i>
                        </button>
                    </td>
                    <td>
                        <button type="button" class="btn btn-outline-primary transfer" data-id="${item.id}">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                    </td>
                    <td>
                        <button type="button" class="btn btn-outline-danger delete" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        function findById(customerId) {
            return $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "GET",
                url: page.urls.getAllCustomers + "/" + customerId
            })
                .done((data) => {
                    customer = data;
                })
                .fail((error) => {
                    console.log(error)
                })
        }

        function newFindById(customerId) {
            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "GET",
                url: page.urls.getAllCustomers + "/" + customerId
            })
                .done((data) => {
                    console.log(data);
                    return data;
                })
                .fail((error) => {
                    console.log(error)
                })
        }

        function countTransferTransaction() {
            document.getElementById("transferAmountTran").addEventListener("input", () => {
                let transferAmount = $("#transferAmountTran").val();
                let fees = 10;
                let feesAmount = +transferAmount * fees / 100;
                let transactionAmount = +transferAmount + feesAmount;

                $("#transactionAmountTran").val(transactionAmount);
            })
        }

        function sweetAlertSuccess(message) {
            Swal.fire({
                position: 'top-end',
                icon: 'success',
                title: `${message} success`,
                showConfirmButton: false,
                timer: 1500
            })
        }

        $("#btnShowCreateModal").on("click", () => {
            $("#modalCreate").modal("show");
        })

        $("#btnCreate").on("click", () => {
            let fullName = $("#fullNameCre").val();
            let email = $("#emailCre").val();
            let phone = $("#phoneCre").val();
            let address = $("#addressCre").val();
            let balance = 0;
            let deleted = 0;

            let customer = {
                fullName,
                email,
                phone,
                address,
                balance,
                deleted
            }

            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "POST",
                url: page.urls.getAllCustomers,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    customer = data;
                    $("#modalCreate").modal("hide");

                    sweetAlertSuccess("Create new customer")

                    let newRow = renderCustomer(customer);

                    $("#tbCustomer tbody").append(newRow);

                    allAddEvent();

                })
                .fail((error) => {
                    console.log(error)
                })
        })

        $("#btnUpdate").on("click", () => {
            let id = +$("#idUp").val();
            let fullName = $("#fullNameUp").val();
            let email = $("#emailUp").val();
            let phone = $("#phoneUp").val();
            let address = $("#addressUp").val();

            let customer = {
                fullName,
                email,
                phone,
                address
            }

            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "PATCH",
                url: page.urls.getAllCustomers + "/" + id,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    customer = data;
                    $("#modalUpdate").modal("hide");

                    let currentRow = $("#tr_" + customer.id);
                    let newRow = renderCustomer(customer);

                    currentRow.replaceWith(newRow);

                    sweetAlertSuccess("Update customer")

                    allAddEvent();

                })
                .fail((error) => {
                    console.log(error)
                })
        })

        $("#btnDeposit").on("click", () => {

            let currentBalance = customer.balance;
            let transactionAmount = +$("#transactionAmountDep").val();
            let newBalance = currentBalance + transactionAmount;
            customer.balance = newBalance;

            let deposit = {
                customerId: customer.id,
                transactionAmount: transactionAmount
            }

            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "POST",
                url: page.urls.doDeposit,
                data: JSON.stringify(deposit)
            })
                .done((data) => {

                })
                .fail((error) => {
                    console.error(error);
                })


            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "PATCH",
                url: page.urls.getAllCustomers + "/" + customer.id,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    customer = data;

                    let currentRow = $("#tr_" + customer.id);
                    let newRow = renderCustomer(customer);

                    currentRow.replaceWith(newRow);

                    $("#modalDeposit").modal("hide");

                    sweetAlertSuccess("Deposit");

                    allAddEvent();
                })
                .fail((error) => {
                    console.error(error);
                })

        })

        $("#btnWithdraw").on("click", () => {
            let currentBalance = customer.balance;
            let transactionAmount = +$("#transactionAmountWith").val();
            let newBalance = currentBalance - transactionAmount;
            customer.balance = newBalance;

            let withdraw = {
                customerId: customer.id,
                transactionAmount: transactionAmount
            }

            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "POST",
                url: page.urls.doWithdraw,
                data: JSON.stringify(withdraw)
            })
                .done((data) => {

                })
                .fail((error) => {
                    console.error(error);
                })


            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "PATCH",
                url: page.urls.getAllCustomers + "/" + customer.id,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    customer = data;

                    let currentRow = $("#tr_" + customer.id);
                    let newRow = renderCustomer(customer);

                    currentRow.replaceWith(newRow);

                    $("#modalWithdraw").modal("hide");

                    sweetAlertSuccess("Withdraw")

                    allAddEvent();
                })
                .fail((error) => {
                    console.error(error);
                })
        })

        $("#btnTransfer").on("click", () => {
            let senderCurrentBalance = customer.balance,
                senderId = customer.id,
                transferAmount = +$("#transferAmountTran").val(),
                fees = 10,
                feesAmount = transferAmount * fees / 100,
                transactionAmount = transferAmount + feesAmount,
                senderNewBalance = senderCurrentBalance - transactionAmount;
            customer.balance = senderNewBalance;

            let sender = { ...customer };

            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "PATCH",
                url: page.urls.getAllCustomers + "/" + sender.id,
                data: JSON.stringify(sender)
            })
                .done((data) => {
                    let recipientId = +$("#recipientId").val();

                    let recipient = newFindById(recipientId);

                    let repipientCurrentBalance = customer.balance,
                        recipientNewBalance = repipientCurrentBalance + transferAmount;
                    customer.balance = recipientNewBalance;


                    $.ajax({
                        headers: {
                            "accept": "application/json",
                            "content-type": "application/json"
                        },
                        type: "PATCH",
                        url: page.urls.getAllCustomers + "/" + recipientId,
                        data: JSON.stringify(recipient)
                    })
                        .done((data) => {
                            let transfer = {
                                fees: 10,
                                feesAmount: feesAmount,
                                transactionAmount: transactionAmount,
                                transferAmount: transferAmount,
                                senderId: senderId,
                                recipientId: customer.id
                            }

                            $.ajax({
                                headers: {
                                    "accept": "application/json",
                                    "content-type": "application/json"
                                },
                                type: "POST",
                                url: page.urls.getAllCustomers,
                                data: JSON.stringify(transfer)
                            })
                                .done((data) => {

                                    let currentSenderRow = $("#tr_" + sender.id);
                                    newSenderRow = renderCustomer(sender);

                                    currentSenderRow.replaceWith(newSenderRow);

                                    let currentRecipientRow = $("#tr_" + recipient.id),
                                        newRecipientRow = renderCustomer(recipient);

                                    currentRecipientRow.replaceWith(newRecipientRow);

                                    $("#modalTransfer").modal("hide");

                                    sweetAlertSuccess("Transfer");

                                    allAddEvent();
                                })
                                .fail((error) => {
                                    console.log(error);
                                })
                        })
                        .fail((error) => {
                            console.log(error);
                        })
                })
                .fail((error) => {
                    console.error(error);
                })
        })

        getAllCustomers();

        function allAddEvent() {

            addEventShowModalUpdate();

            addEventShowModalDeposit();

            addEventShowModalWithdraw();

            addEventShowModelTransfer();

            addEventShowConfirmDelete();
        }

    </script>
</th:block>
</body>
</html>