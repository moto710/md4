<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Template</title>
    <th:block th:fragment="head">
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/assets/bootstrap/v5.3.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="/assets/fontawesome/v5.15.4/css/all.min.css">
        <link rel="stylesheet" href="/assets/sweetalert2/v11.7.0/sweetalert2.min.css">
        <link rel="stylesheet" href="/assets/css/style.css">
    </th:block>
</head>
<body>

<th:block th:fragment="script">
    <script src="/assets/jquery/v3.6.3/jquery-3.6.3.min.js"></script>
    <script src="/assets/bootstrap/v5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/sweetalert2/v11.7.0/sweetalert2.min.js"></script>
    <script src="/assets/js/appBase.js"></script>
    <script src="/assets/jquery-validate/v1.19.5/jquery.validate.min.js"></script>
    <script>
        const page = {
            urls: {
                getAllCustomers: AppBase.API_CUSTOMER + "?deleted=0",
                postNewCustomer: AppBase.API_CUSTOMER,
                getCustomer: AppBase.API_CUSTOMER + "/",
                doDeposit: AppBase.API_DEPOSIT,
                doWithdraw: AppBase.API_WITHDRAW,
                doTransfer: AppBase.API_TRANSFER
            }
        }

        let customer = {};

        function getAllCustomers() {
            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "GET",
                url: page.urls.getAllCustomers
            })
                .done((data) => {
                    $.each(data, (i, item) => {
                        let str = renderCustomer(item);
                        $("#tbCustomer tbody").append(str);
                    })

                    allAddEvent();
                })
                .fail((error) => {
                    console.log(error)
                })
        }

        function addEventShowModalUpdate() {
            $(".update").on("click", function () {
                let customerId = $(this).data("id");

                findById(customerId).then(() => {

                    if (customer !== null) {
                        $("#idUp").val(customer.id);
                        $("#fullNameUp").val(customer.fullName);
                        $("#emailUp").val(customer.email);
                        $("#phoneUp").val(customer.phone);
                        $("#addressUp").val(customer.address);

                        $("#modalUpdate").modal("show");
                    }
                });
            })
        }

        function addEventShowModalDeposit() {
            $(".deposit").on("click", function () {
                let customerId = $(this).data("id");

                findById(customerId).then(() => {
                    if (customer !== null) {
                        $("#idDep").val(customer.id);
                        $("#fullNameDep").val(customer.fullName);
                        $("#balanceDep").val(customer.balance);

                        $("#modalDeposit").modal("show");
                    }
                });
            })
        }

        function addEventShowModalWithdraw() {
            $(".withdraw").on("click", function () {
                let customerId = $(this).data("id");

                findById(customerId).then(() => {
                    if (customer !== null) {
                        $("#idWith").val(customer.id);
                        $("#fullNameWith").val(customer.fullName);
                        $("#balanceWith").val(customer.balance);

                        $("#modalWithdraw").modal("show");
                    }
                });
            })
        }

        function addEventShowModalTransfer() {
            $(".transfer").on("click", function () {
                let senderId = +$(this).data("id");

                findById(senderId).then(() => {
                    if (customer !== null) {
                        $("#idCustomerSend").val(customer.id);
                        $("#fullNameSend").val(customer.fullName);
                        $("#emailSend").val(customer.email);
                        $("#balanceSend").val(customer.balance);
                        $("#recipientId").empty();
                        $("#modalTransfer").modal("show");

                        $.ajax({
                            headers: {
                                "accept": "application/json",
                                "content-type": "application/json"
                            },
                            type: "GET",
                            url: page.urls.getAllCustomers
                        })
                            .done((data) => {
                                $.each(data, (i, item) => {
                                    if (item.id !== customer.id) {
                                        let str = renderSelectOptionRecipient(item);
                                        $("#recipientId").append("beforeend", str);
                                    }
                                })

                                countTransferTransaction();

                                // allAddEvent();
                            })
                            .fail((error) => {
                                console.log(error);
                            })
                    }
                });
            })
        }

        function addEventShowModalTransferHistory() {
            console.log("test")
            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "GET",
                url: page.urls.doTransfer
            })
                .done((data) => {
                    $.each(data, (i, transfer) => {
                        let senderId = transfer.senderId,
                            recipientId = transfer.recipientId,
                            senderName = '',
                            recipientName = '';

                        findById(senderId).then(() => {
                            senderName = customer.fullName;
                            findById(recipientId).then(() => {
                                recipientName = customer.fullName;

                                let str = renderShowTransferHistory(transfer, senderName, recipientName);
                                $("#tbTransferHistory tbody").append(str);
                            })
                        })
                    })
                })
                .fail((error) => {
                    console.log(error);
                });
        }

        function addEventShowConfirmDelete() {
            $(".delete").on("click", function () {
                let customerId = $(this).data("id");

                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {

                        let customer = {
                            deleted: 1
                        }

                        $.ajax({
                            headers: {
                                "accept": "application/json",
                                "content-type": "application/json"
                            },
                            type: "PATCH",
                            url: page.urls.getAllCustomers + "/" + customerId,
                            data: JSON.stringify(customer)
                        })
                            .done((data) => {
                                $("#tr_" + customerId).remove();

                                sweetAlertSuccess("Delete customer");
                            })
                            .fail((error) => {
                                console.log(error)
                            })
                    }
                })
            })
        }

        function renderSelectOptionRecipient(item) {
            return `
                <option value="${item.id}">${item.fullName}</option>
                `;
        }

        function renderShowTransferHistory(transfer, senderName, recipientName) {
            return `
                                <tr>
                                    <td>${transfer.id}</td>
                                    <td>${transfer.senderId}</td>
                                    <td>${senderName}</td>
                                    <td>${transfer.recipientId}</td>
                                    <td>${recipientName}</td>
                                    <td>${transfer.transferAmount}</td>
                                    <td>${transfer.transactionAmount}</td>
                                </tr>
                                `;
        }

        function renderCustomer(item) {
            return `
                <tr id="tr_${item.id}">
                    <td class="text-center">${item.id}</td>
                    <td>${item.name}</td>
                    <td class="text-center">${item.email}</td>
                    <td class="text-center">${item.phone}</td>
                    <td class="text-end">${item.balance}</td>
                    <td>${item.address}</td>
                    <td>
                        <button type="button" class="btn btn-outline-secondary update" data-id="${item.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                    <td>
                        <button type="button" class="btn btn-outline-success deposit" data-id="${item.id}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>
                    <td>
                        <button type="button" class="btn btn-outline-warning withdraw" data-id="${item.id}">
                            <i class="fas fa-minus"></i>
                        </button>
                    </td>
                    <td>
                        <button type="button" class="btn btn-outline-primary transfer" data-id="${item.id}">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                    </td>
                    <td>
                        <button type="button" class="btn btn-outline-danger delete" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        function findById(customerId) {
            return $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "GET",
                url: page.urls.getCustomer + customerId
            })
                .done((data) => {
                    customer = data;
                })
                .fail((error) => {
                    console.log(error)
                })
        }

        function countTransferTransaction() {
            document.getElementById("transferAmountTran").addEventListener("input", () => {
                let transferAmount = $("#transferAmountTran").val(),
                    fees = 10,
                    feesAmount = +transferAmount * fees / 100,
                    transactionAmount = +transferAmount + feesAmount;

                $("#transactionAmountTran").val(transactionAmount);
            })
        }

        function checkBiggerThanBalance() {
            let transactionAmount = +$("#transactionAmountWith").val(),
                balanceWith = +$("#balanceWith").val();
            return transactionAmount <= balanceWith;
        }

        function checkBiggerThanBalanceWithFee() {
            let transactionAmount = +$("#transferAmountTran").val(),
                balance = +$("#balanceSend").val(),
                feesAmount = transactionAmount * 10 / 100;
            return balance >= transactionAmount + feesAmount;
        }

        function sweetAlertSuccess(message) {
            Swal.fire({
                position: 'center',
                icon: 'success',
                title: `${message} success`,
                showConfirmButton: false,
                timer: 1500
            })
        }

        function createCustomer() {
            let fullName = $("#fullNameCre").val(),
                email = $("#emailCre").val(),
                phone = $("#phoneCre").val(),
                address = $("#addressCre").val(),
                balance = 0,
                deleted = 0;

            let customer = {
                fullName,
                email,
                phone,
                address,
                balance,
                deleted
            }

            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "POST",
                url: page.urls.postNewCustomer,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    customer = data;
                    $("#modalCreate").modal("hide");

                    sweetAlertSuccess("Create new customer")

                    let newRow = renderCustomer(customer);

                    $("#tbCustomer tbody").append(newRow);

                    allAddEvent();

                })
                .fail((error) => {
                    console.log(error)
                })
        }

        function updateCustomer() {
            let id = +$("#idUp").val(),
                fullName = $("#fullNameUp").val(),
                email = $("#emailUp").val(),
                phone = $("#phoneUp").val(),
                address = $("#addressUp").val();

            let customer = {
                fullName,
                email,
                phone,
                address
            }

            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "PATCH",
                url: page.urls.getCustomer + id,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    customer = data;
                    $("#modalUpdate").modal("hide");

                    let currentRow = $("#tr_" + customer.id);
                    let newRow = renderCustomer(customer);

                    currentRow.replaceWith(newRow);

                    sweetAlertSuccess("Update customer");

                    allAddEvent();

                })
                .fail((error) => {
                    console.log(error)
                })
        }

        function deposit() {
            let currentBalance = customer.balance;
            let transactionAmount = +$("#transactionAmountDep").val();
            let newBalance = currentBalance + transactionAmount;
            customer.balance = newBalance;

            let deposit = {
                customerId: customer.id,
                transactionAmount: transactionAmount
            }

            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "POST",
                url: page.urls.doDeposit,
                data: JSON.stringify(deposit)
            })
                .done((data) => {

                })
                .fail((error) => {
                    console.error(error);
                })

            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "PATCH",
                url: page.urls.getCustomer + customer.id,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    customer = data;

                    let currentRow = $("#tr_" + customer.id);
                    let newRow = renderCustomer(customer);

                    currentRow.replaceWith(newRow);

                    $("#modalDeposit").modal("hide");

                    sweetAlertSuccess("Deposit");

                    allAddEvent();
                })
                .fail((error) => {
                    console.error(error);
                })
        }

        function withdraw() {
            let currentBalance = customer.balance,
                transactionAmount = +$("#transactionAmountWith").val(),
                newBalance = currentBalance - transactionAmount;
            customer.balance = newBalance;

            let withdraw = {
                customerId: customer.id,
                transactionAmount: transactionAmount
            }

            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "PATCH",
                url: page.urls.getCustomer + customer.id,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    $.ajax({
                        headers: {
                            "accept": "application/json",
                            "content-type": "application/json"
                        },
                        type: "POST",
                        url: page.urls.doWithdraw,
                        data: JSON.stringify(withdraw)
                    })
                        .done((data) => {

                        })
                        .fail((error) => {
                            console.error(error);
                        })
                    customer = data;

                    let currentRow = $("#tr_" + customer.id);
                    let newRow = renderCustomer(customer);

                    currentRow.replaceWith(newRow);

                    $("#modalWithdraw").modal("hide");

                    sweetAlertSuccess("Withdraw")

                    allAddEvent();
                })
                .fail((error) => {
                    console.error(error);
                })
        }

        function transfer() {
            let sender = structuredClone(customer);

            let senderCurrentBalance = sender.balance,
                transferAmount = +$("#transferAmountTran").val(),
                fees = 10,
                feesAmount = transferAmount * fees / 100,
                transactionAmount = transferAmount + feesAmount,
                senderNewBalance = senderCurrentBalance - transactionAmount;
            sender.balance = senderNewBalance;

            $.ajax({
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json"
                },
                type: "PATCH",
                url: page.urls.getCustomer + sender.id,
                data: JSON.stringify(sender)
            })
                .done((data) => {
                    let recipientId = +$("#recipientId").find(":selected").val();
                    findById(recipientId).then(() => {
                        let recipient = structuredClone(customer),
                            recipientCurrentBalance = recipient.balance,
                            recipientNewBalance = recipientCurrentBalance + transferAmount;
                        recipient.balance = recipientNewBalance;

                        $.ajax({
                            headers: {
                                "accept": "application/json",
                                "content-type": "application/json"
                            },
                            type: "PATCH",
                            url: page.urls.getCustomer + recipient.id,
                            data: JSON.stringify(recipient)
                        })
                            .done((data) => {
                                let transfer = {
                                    fees: 10,
                                    feesAmount: feesAmount,
                                    transactionAmount: transactionAmount,
                                    transferAmount: transferAmount,
                                    senderId: sender.id,
                                    recipientId: recipient.id
                                }

                                $.ajax({
                                    headers: {
                                        "accept": "application/json",
                                        "content-type": "application/json"
                                    },
                                    type: "POST",
                                    url: page.urls.doTransfer,
                                    data: JSON.stringify(transfer)
                                })
                                    .done((data) => {

                                        let currentSenderRow = $("#tr_" + sender.id);
                                        newSenderRow = renderCustomer(sender);

                                        currentSenderRow.replaceWith(newSenderRow);

                                        let currentRecipientRow = $("#tr_" + recipient.id),
                                            newRecipientRow = renderCustomer(recipient);

                                        currentRecipientRow.replaceWith(newRecipientRow);

                                        $("#modalTransfer").modal("hide");

                                        sweetAlertSuccess("Transfer");

                                        allAddEvent();
                                    })
                                    .fail((error) => {
                                        console.log(error);
                                    })
                            })
                            .fail((error) => {
                                console.log(error);
                            })
                    });
                })
                .fail((error) => {
                    console.error(error);
                })
        }

        $("#btnShowCreateModal").on("click", () => {
            $("#modalCreate").modal("show");
        })

        $("#btnShowTransferHistoryModal").click(() => {
            $("#modalTransferHistory").modal("show");
            addEventShowModalTransferHistory();
        })

        $("#btnCreate").on("click", () => {
            $("#frmCreateCustomer").trigger("submit");
        })

        $("#btnUpdate").on("click", () => {
            $("#frmUpdateCustomer").trigger("submit");
        })

        $("#btnDeposit").on("click", () => {
            $("#frmDeposit").trigger("submit");
        })

        $("#btnWithdraw").on("click", () => {
            $("#frmWithdraw").trigger("submit");
        })

        $("#btnTransfer").on("click", () => {
            $("#frmTransfer").trigger("submit");
        })

        $("#modalCreate").on("hidden.bs.modal", () => {
            $("#frmCreateCustomer")[0].reset();
            $("#frmCreateCustomer").validate().resetForm();
        })

        $("#modalWithdraw").on("hidden.bs.modal", () => {
            $("#frmWithdraw")[0].reset();
            $("#frmWithdraw").validate().resetForm();
        })

        $("#modalDeposit").on("hidden.bs.modal", () => {
            $("#frmDeposit")[0].reset();
            $("#frmDeposit").validate().resetForm();
        })

        $("#modalTransfer").on("hidden.bs.modal", () => {
            $("#frmTransfer")[0].reset();
            $("#frmTransfer").validate().resetForm();
        })

        $("#modalTransferHistory").on("hidden.bs.modal", () => {
            $("#tbTransferHistory tbody").empty();
        })

        $("#frmCreateCustomer").validate({
            rules: {
                fullNameCre: {
                    required: true,
                    minlength: 4
                },
                emailCre: {
                    required: true,
                    email: false,
                    isValidEmail: true
                },
                phoneCre: {
                    required: true,
                    isValidPhone: true
                }
            },
            messages: {
                fullNameCre: {
                    required: "Full name is required.",
                    minlength: "Full name must be more than 4 letters"
                },
                emailCre: {
                    required: "Email is required.",
                },
                phoneCre: {
                    required: "Phone number is required"
                }
            },
            errorLabelContainer: "#modalCreate .modal-alert-danger",
            errorPlacement: function (error, element) {
                error.appendTo("#modalCreate .modal-alert-danger");
            },
            showErrors: function (errorMap, errorList) {
                if (this.numberOfInvalids() > 0) {
                    $("#modalCreate .modal-alert-danger").removeClass("hidden").addClass("show");
                } else {
                    $("#modalCreate .modal-alert-danger").removeClass("show").addClass("hidden").empty();
                    $("#frmCreateCustomer input.error").removeClass("error");
                }
                this.defaultShowErrors();
            },
            submitHandler: () => {
                createCustomer();
            }
        });

        $("#frmUpdateCustomer").validate({
            rules: {
                fullNameUp: {
                    required: true,
                    minlength: 4
                },
                emailUp: {
                    required: true,
                    email: false,
                    isValidEmail: true
                },
                phoneUp: {
                    required: true,
                    isValidPhone: true
                }
            },
            messages: {
                fullNameUp: {
                    required: "Full name is required.",
                    minlength: "Full name must be more than 4 letters"
                },
                emailUp: {
                    required: "Email is required.",
                },
                phoneUp: {
                    required: "Phone number is required"
                }
            },
            errorLabelContainer: "#modalUpdate .modal-alert-danger",
            errorPlacement: function (error, element) {
                error.appendTo("#modalUpdate .modal-alert-danger");
            },
            showErrors: function (errorMap, errorList) {
                if (this.numberOfInvalids() > 0) {
                    $("#modalUpdate .modal-alert-danger").removeClass("hidden").addClass("show");
                } else {
                    $("#modalUpdate .modal-alert-danger").removeClass("show").addClass("hidden").empty();
                    $("#frmUpdateCustomer input.error").removeClass("error");
                }
                this.defaultShowErrors();
            },
            submitHandler: () => {
                updateCustomer();
            }
        });

        $("#frmDeposit").validate({
            rules: {
                transactionAmountDep: {
                    required: true,
                    number: true,
                    min: 10,
                    max: 1000000000
                }
            },
            messages: {
                transactionAmountDep: {
                    required: "Please fill your money to deposit.",
                    min: "Minimum amount to deposit is 10$",
                    max: "Maximum amount to deposit is 1.000.000.000$",
                    number: "Only number in this field!"
                }
            },
            errorLabelContainer: "#modalDeposit .modal-alert-danger",
            errorPlacement: function (error, element) {
                error.appendTo("#modalDeposit .modal-alert-danger");
            },
            showErrors: function (errorMap, errorList) {
                if (this.numberOfInvalids() > 0) {
                    $("#modalDeposit .modal-alert-danger").removeClass("hidden").addClass("show");
                } else {
                    $("#modalDeposit .modal-alert-danger").removeClass("show").addClass("hidden").empty();
                    $("#frmDeposit input.error").removeClass("error");
                }
                this.defaultShowErrors();
            },
            submitHandler: () => {
                deposit();
            }
        });

        $("#frmWithdraw").validate({
            rules: {
                transactionAmountWith: {
                    required: true,
                    number: true,
                    min: 10,
                    max: 1000000000,
                    isBiggerThanBalance: true
                }
            },
            messages: {
                transactionAmountWith: {
                    required: "Please fill your money to withdraw.",
                    min: "Minimum amount to withdraw is 10$",
                    max: "Maximum amount to withdraw is 1.000.000.000$",
                    number: "Only number in this field!"
                }
            },
            errorLabelContainer: "#modalWithdraw .modal-alert-danger",
            errorPlacement: function (error, element) {
                error.appendTo("#modalWithdraw .modal-alert-danger");
            },
            showErrors: function (errorMap, errorList) {
                if (this.numberOfInvalids() > 0) {
                    $("#modalWithdraw .modal-alert-danger").removeClass("hidden").addClass("show");
                } else {
                    $("#modalWithdraw .modal-alert-danger").removeClass("show").addClass("hidden").empty();
                    $("#frmWithdraw input.error").removeClass("error");
                }
                this.defaultShowErrors();
            },
            submitHandler: () => {
                withdraw();
            }
        });

        $("#frmTransfer").validate({
            rules: {
                transferAmountTran: {
                    required: true,
                    number: true,
                    min: 10,
                    max: 1000000000,
                    isBiggerThanBalanceWithFee: true
                }
            },
            messages: {
                transferAmountTran: {
                    required: "Please fill your money to transfer.",
                    min: "Minimum amount to transfer is 10$",
                    max: "Maximum amount to transfer is 1.000.000.000$",
                    number: "Only number in this field!"
                }
            },
            errorLabelContainer: "#modalTransfer .modal-alert-danger",
            errorPlacement: function (error, element) {
                error.appendTo("#modalTransfer .modal-alert-danger");
            },
            showErrors: function (errorMap, errorList) {
                if (this.numberOfInvalids() > 0) {
                    $("#modalTransfer .modal-alert-danger").removeClass("hidden").addClass("show");
                } else {
                    $("#modalTransfer .modal-alert-danger").removeClass("show").addClass("hidden").empty();
                    $("#frmTransfer input.error").removeClass("error");
                }
                this.defaultShowErrors();
            },
            submitHandler: () => {
                transfer();
            }
        });

        $.validator.addMethod("isValidEmail", function (value, element) {
            return this.optional(element) || /^[\w]+@([\w-]+\.)+[\w-]{2,6}$/i.test(value);
        }, "Invalid email! Example: abc@domain.xyz");

        $.validator.addMethod("isValidPhone", function (value, element) {
            return this.optional(element) || /^(0?)(3[2-9]|5[6|8|9]|7[0|6-9]|8[0-6|8|9]|9[0-4|6-9])[0-9]{7}$/i.test(value);
        }, "Invalid phone number! Example: 909298966 or 0909298966");

        $.validator.addMethod("isBiggerThanBalance", function (value, element) {
            return this.optional(element) || checkBiggerThanBalance();
        }, "Withdraw amount must be less than your balance!");

        $.validator.addMethod("isBiggerThanBalanceWithFee", function (value, element) {
            return this.optional(element) || checkBiggerThanBalanceWithFee();
        }, "Not enough money to do transfer!");

        getAllCustomers();

        function allAddEvent() {

            addEventShowModalUpdate();

            addEventShowModalDeposit();

            addEventShowModalWithdraw();

            addEventShowModalTransfer();

            addEventShowConfirmDelete();
        }

    </script>
</th:block>
</body>
</html>